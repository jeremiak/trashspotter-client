<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://getbootstrap.com/examples/sticky-footer/sticky-footer.css">
    <style type="text/css">
      .row {
        padding-top:9px;
        text-align:center;
      }
      .glyphicon-trash {
        opacity:0.5;
        font-size:60pt;
        text-decoration:none;
      }
      #footer span {
        margin-right:7px;
      }
     #google_canvas { 
       height: 100%;
       left: 0;
       position:absolute;
       top: 0;
       width: 100%;
     }

     .container {
       margin: auto;
       pointer-events: auto;
     }
     
     .overlay {
       pointer-events:none;
       position: absolute;
       width: 100%;
     }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>
      <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>

  </head>
  <body>
    <div id="google_canvas"></div>

    <div class="overlay">
      <div class="container">
        <div class="row">
          <h1>TrashSpotter</h1>
        </div>
        <div class="row">
          <span class="glyphicon glyphicon-trash"></span>
        </div>
        <div class="row">
          <button id="trash" type="button" class="btn btn-primary btn-lg">
            I'm next to a trash can!</button>
        </div>
      </div>
    </div>

    <div id="footer">
      <div class="container">
        <div class="row">
          <a class="text-muted" href="map.html"><span 
              class="glyphicon glyphicon-globe"></span>Map of trash cans</a>
        </div>
      </div>
    </div>
    
    <script type="text/javascript">
    Parse.initialize("mdcl9TzaR9eXsEnUdIhGtUGqUBwLQbHlKIyKhl1G", "NDdDQsfMWLAPHTjI8ctVFEdCJsYTxcoy00Q7beKu"); 
      (function() {
        var ts = {};
        ts.DEFAULT_ZOOM = 18;
        ts.DEFAULT_LAT = 37.7793;
        ts.DEFAULT_LNG = -122.4175;

        ts.googleForm = 'https://docs.google.com/forms/d/1sRrEC48obY6ZXZX3zoJYUZ-GBVZq3YJktRufCixO__Y/formResponse';
        ts.herokuHost = 'http://trashspotter--google--proxy-herokuapp-com-ptypn8aumpr3.runscope.net';
        ts.marker;

        ts.pingHeroku = function() {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', ts.herokuHost);
          xhr.send();
        };

        ts.getLocation = function(opts) {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(opts.success, opts.error);
          } else {
            opts.error && opts.error("Location not supported");
          }
        };

        ts.handleRegisterGarbageCanClick = function(ev) {
          ev.preventDefault();
          ts.registerGarbageCan();
        }

        ts.registerGarbageCan = function(ev) {

          ts.getLocation({
            success: function(data) {
              alert("submitting!: ");
                  var Can = Parse.Object.extend("Can");
                  var can = new Can();
                  lat=position.coords.latitude;
                  lon=position.coords.longitude;
                  latlon=new google.maps.LatLng(lat, lon)
                  acc=position.coords.accuracy;
                  // these should probably be passed to submitLocation()

                  can.set("lat", lat);
                  can.set("lon", lon);
                  can.set("acc", acc);
                  can.save(null, {
                    success: function(can) {
                      // Execute any logic that should take place after the object is saved.
                      alert('saved your new can with accuracy: ' + acc + ' meters' );
                      // watchId = navigator.geolocation.watchPosition(showPosition);

                    },
                    error: function(can, error) {
                      // Execute any logic that should take place if the save fails.
                      // error is a Parse.Error with an error code and description.
                      alert('Failed to save, error code: ' + error.description);
                      // watchId = navigator.geolocation.watchPosition(showPosition);

                    }
                  });
              // var xhr = new XMLHttpRequest(),
              //     coords,
              //     parameters;

              // coords = data.coords;
              // parameters = encodeURI('lat=' + coords.latitude + 
              //   '&long=' + coords.longitude + 
              //   '&accuracy=' + coords.accuracy);
              // xhr.open('POST', ts.herokuHost + '/garbage_can');
              // xhr.send(parameters);
              // xhr.onreadystatechange = function() {
              //   if (xhr.readyState === 4 && xhr.status === 200) {
              //     alert('Got it!');
              //   }
              //   else if (xhr.readyState === 4 && xhr.status !== 200){
              //     alert('Try again');
              //   }
              // };
            },
            error: function(err) { 
              console.debug(err);
              alert('error code: ' + err.code + ' error message ' + err.message); 
            }
          });
        };

        ts.initMap = function(data) {
          var map, 
              mapOpts,
              geoLocate,
              coords = data && data.coords;
            
          mapOpts = {
            center: new google.maps.LatLng(ts.DEFAULT_LAT, ts.DEFAULT_LNG),
            zoom: ts.DEFAULT_ZOOM,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          }

          map = new google.maps.Map(document.getElementById('google_canvas'), 
              mapOpts);

          if (coords) {
            geoLocate = new google.maps.LatLng(coords.latitude, 
                coords.longitude);

            map.setCenter(geoLocate);

            ts.marker = new google.maps.Marker({
              position: geoLocate,
              title: 'Current Location',
              map: map
            });
          }

          return map;
        };

        ts.init = function() {
          ts.pingHeroku();
          ts.getLocation({
            success: function(data) {
              ts.map = ts.initMap(data);
            },
            error: function() {
              ts.map = ts.initMap();
            }
          });
          document.getElementById('trash').addEventListener('click', 
              ts.handleRegisterGarbageCanClick);
        };

        ts.init();
      })();
    </script>
  </body>
</html>
