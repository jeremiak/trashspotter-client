<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//getbootstrap.com/examples/sticky-footer/sticky-footer.css">
    <style type="text/css">
      .row {
        padding-top:9px;
        text-align:center;
      }
      .glyphicon-trash {
        opacity:0.5;
        font-size:60pt;
        text-decoration:none;
      }
      #footer span {
        margin-right:7px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1>TrashSpotter</h1>
      </div>
      <div class="row">
        <span class="glyphicon glyphicon-trash"></span>
      </div>
      <div class="row">
        <button id="trash" type="button" class="btn btn-primary btn-lg">
          I'm next to a trash can!</button>
      </div>
    </div>

    <div id="footer">
      <div class="container">
        <div class="row">
          <a class="text-muted" href="map.html"><span 
              class="glyphicon glyphicon-globe"></span>Map of trash cans</a>
        </div>
      </div>
    </div>
    
    <script type="text/javascript">
      (function() {
        var ts = {};
        ts.googleForm = 'https://docs.google.com/forms/d/1sRrEC48obY6ZXZX3zoJYUZ-GBVZq3YJktRufCixO__Y/formResponse';
        ts.herokuHost = 'http://trashspotter--google--proxy-herokuapp-com-ptypn8aumpr3.runscope.net';

        ts.pingHeroku = function() {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', ts.herokuHost);
          xhr.send();
        };

        ts.getLocation = function(opts) {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(opts.success, opts.error);
          } else {
            opts.error && opts.error("Location not supported");
          }
        };

        ts.handleRegisterGarbageCanClick = function(ev) {
          ev.preventDefault();
          ts.registerGarbageCan();
        }

        ts.registerGarbageCan = function(ev) {

          ts.getLocation({
            success: function(data) {
              var xhr = new XMLHttpRequest(),
                  coords,
                  parameters;

              coords = data['coords'];
              parameters = encodeURI('lat=' + coords['latitude'] + 
                '&long=' + coords['longitude']);
              xhr.open('POST', ts.herokuHost + '/garbage_can');
              xhr.send(parameters);
              xhr.onreadystatechange = function() {
                if (xhr.readyState==4 && xhr.status==200) {
                  alert('Got it!');
                }
                else if (xhr.readyState==4 && xhr.status!=200){
                  alert('Try again');
                }
              };
            },
            error: function(err) { 
              console.debug(err);
              alert('There was an error trying to save location ' + err.message); 
            }
          });
        };

        ts.init = function() {
          ts.pingHeroku();
          document.getElementById('trash').addEventListener('click', 
              ts.handleRegisterGarbageCanClick);
        };

        ts.init();
      })();
    </script>
  </body>
</html>
