<!doctype html>
<head>
  <meta charset="utf-8">

  <title>trashspotter</title>
  <meta name="description" content="trashspot">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
</head>

<body>
  
  <div id="main">
    <h1>OMG find the trashcans. </h1>

    <p>with parse(.com) as the database and all javascript that runs client side</p>

    <ul>
      <li>hi</li>
    </ul>

    <div style="display:none" class="error">
      Looks like there was a problem saving the test object. Make sure you've set your application ID and javascript key correctly in the call to <code>Parse.initialize</code> in this file.
    </div>

    <div style="display:none" class="success">
      hi again!
    </div>
  </div>
  <p>
  <p>green = existing cans, red = you</p>
    <p id="curr_loc">  </p>
  <div id="mapholder"></div>
 <button onclick="submitLocation()">I'm next to a trash can!</button>

<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script type="text/javascript">
    Parse.initialize("mdcl9TzaR9eXsEnUdIhGtUGqUBwLQbHlKIyKhl1G", "NDdDQsfMWLAPHTjI8ctVFEdCJsYTxcoy00Q7beKu");    
    var TestObject = Parse.Object.extend("TestObject");
    var testObject = new TestObject();
      testObject.save({foo: "bar"}, {
      success: function(object) {
        $(".success").show();
      },
      error: function(model, error) {
        $(".error").show();
      }

    });

var x=document.getElementById("curr_loc");
navigator.geolocation.watchPosition(showPosition);


function showPosition(position)
  {
  lat=position.coords.latitude;
  lon=position.coords.longitude;
  latlon=new google.maps.LatLng(lat, lon)
  acc=position.coords.accuracy;
  x.innerHTML="you at: " + latlon + "<br> accuracy in meters: " + acc;  
  mapholder=document.getElementById('mapholder')
  mapholder.style.height='250px';
  mapholder.style.width='50%';

  var myOptions={
  center:latlon,zoom:16,
  mapTypeId:google.maps.MapTypeId.ROADMAP,
  mapTypeControl:false,
  navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
  };
  var map=new google.maps.Map(document.getElementById("mapholder"),myOptions);
  var currentMarker=new google.maps.Marker({position:latlon,map:map,title:"You are here!"});
  var canIcon = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'

  var Can = Parse.Object.extend("Can");
  var query = new Parse.Query(Can);
  query.lessThan("acc", 60);    
  query.find({
    success: function(results) {
      x.innerHTML = x.innerHTML + "<br>Successfully retrieved " + results.length + " can locations."
      // var canMarker = new google.maps.Marker({position:latlon,map:map,title:"another can!",icon:canIcon});
     
      // Do something with the returned Parse.Object values
      for (var i = 0; i < results.length; i++) { 
          latlon=new google.maps.LatLng(results[i].get('lat'),results[i].get('lon')) 
          var canMarker = new google.maps.Marker({position:latlon,map:map,title:"another can!",icon:canIcon});
      }
    },
    error: function(error) {
      alert("Error: " + error.code + " " + error.message);
    }


  });
  }

function getPos(position)
  {
  return position;
  }
function submitLocation()
  {
    alert("submitting!: ");
    position = navigator.geolocation.getCurrentPosition(getPos)
    var Can = Parse.Object.extend("Can");
    var can = new Can();
    lat=position.coords.latitude;
    lon=position.coords.longitude;
    latlon=new google.maps.LatLng(lat, lon)
    acc=position.coords.accuracy;
    // these should probably be passed to submitLocation()

    can.set("lat", lat);
    can.set("lon", lon);
    can.set("acc", acc);
    can.save(null, {
      success: function(can) {
        // Execute any logic that should take place after the object is saved.
        alert('saved your new can with accuracy: ' + acc + ' meters' );
      },
      error: function(can, error) {
        // Execute any logic that should take place if the save fails.
        // error is a Parse.Error with an error code and description.
        alert('Failed to save, error code: ' + error.description);
      }
    });
  }

  </script>
</body>

</html>
